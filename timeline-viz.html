<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Timeline Visualization</title>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/data.js"></script>
    <script src="https://code.highcharts.com/modules/drilldown.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <script src="https://rawgit.com/mholt/PapaParse/master/papaparse.js"></script>
  </head>
  <body>
    <figure class="highcharts-figure">
      <div id="container"></div>
    </figure>

    <script>
      const year = "1990";
      const drilldownPromise = fetch(
        `https://s3.amazonaws.com/datastore.portfolio.sampastoriza.com/viz_data/vehicle_drilldown_data_${year}.csv`
      )
        .then((result) => result.text())
        .then((text) =>
          Papa.parse(text, { header: true, skipEmptyLines: true })
        )
        .then((parsedData) => {
          const drilldowns = parsedData.data.reduce((combined, next) => {
            if (!!combined[next.drilldown]) {
              if (combined[next.drilldown].some((el) => el.name == next.Sex)) {
                const data = combined[next.drilldown].find(
                  (el) => el.name == next.Sex
                );
                data.data.push({
                  y: parseInt(next.NumberOfPeople),
                  name: next.AgeGroup,
                });
              } else {
                combined[next.drilldown].push({
                  name: next.Sex,
                  color: next.Sex == "Female" ? "pink" : "blue",
                  data: [
                    {
                      y: parseInt(next.NumberOfPeople),
                      name: next.AgeGroup,
                    },
                  ],
                  xAxis: 1,
                });
              }
            } else {
              combined[next.drilldown] = [
                {
                  name: next.Sex,
                  color: next.Sex == "Female" ? "pink" : "blue",
                  data: [
                    {
                      y: parseInt(next.NumberOfPeople),
                      name: next.AgeGroup,
                    },
                  ],
                  xAxis: 1,
                },
              ];
            }
            return combined;
          }, {});

          console.log("Drilldown Data", drilldowns);
          return drilldowns;
        });

      const seriesPromise = fetch(
        `https://s3.amazonaws.com/datastore.portfolio.sampastoriza.com/viz_data/vehicle_series_data_${year}.csv`
      )
        .then((result) => result.text())
        .then((text) =>
          Papa.parse(text, { header: true, skipEmptyLines: true })
        )
        .then((parsedData) => {
          const seriesData = parsedData.data.reduce((combined, next) => {
            if (combined.some((el) => el.name == next.SeverityOfInjury)) {
              const injuryData = combined.find(
                (el) => el.name == next.SeverityOfInjury
              );
              injuryData.data.push({
                y: parseInt(next.NumberOfPeople),
                name: next.SeatingPosition,
                drilldown: next.drilldown,
              });
            } else {
              combined.push({
                name: next.SeverityOfInjury,
                data: [
                  {
                    y: parseInt(next.NumberOfPeople),
                    name: next.SeatingPosition,
                    drilldown: next.drilldown,
                  },
                ],
              });
            }
            return combined;
          }, []);

          console.log("series data", seriesData);
          return seriesData;
        });

      Promise.all([drilldownPromise, seriesPromise]).then(
        ([drilldowns, seriesData]) => {
          Highcharts.chart("container", {
            chart: {
              type: "column",
              events: {
                drilldown: function (e) {
                  if (!e.seriesOptions) {
                    const chart = this;
                    const seriesList = drilldowns[e.point.drilldown];
                    for (let series of seriesList) {
                      chart.addSingleSeriesAsDrilldown(e.point, series);
                    }
                    chart.applyDrilldown();
                  }
                },
              },
            },
            title: {
              text: `Locations of Passengers vs Severity of Injury (${year})`,
            },
            xAxis: [
              {
                type: "category",
                categories: ["Driver", "Passenger", "Back Seat"],
              },
              {
                type: "category",
                categories: [
                  "Child (0-12)",
                  "Teen (13-19)",
                  "Young Adult (20-35)",
                  "Adult (35-60)",
                  "Senior (60+)",
                ],
              },
            ],
            legend: {
              enabled: true,
            },
            plotOptions: {
              series: {
                borderWidth: 0,
                dataLabels: {
                  enabled: true,
                },
              },
            },
            series: seriesData,
          });
        }
      );
    </script>
  </body>
</html>
